<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Аркан Дня</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>html,body,#root{height:100%;margin:0;padding:0;background:#0b0b0b;color:#eaeaea;}</style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel" data-presets="env,react">
    const RELAY_URL = "https://arkan-relay.dailyarkan.workers.dev"; // исправлен адрес воркера
    const NOTIFY_ENABLED = true;

    function startOfDay(date){const d=new Date(date);d.setHours(0,0,0,0);return d;}
    function addDays(date,days){const d=new Date(date);d.setDate(d.getDate()+days);return d;}
    function fmtDateKey(d){return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;}
    function fmtHumanDate(d){return d.toLocaleDateString('ru-RU',{day:'2-digit',month:'long',year:'numeric'});}    
    function loadBookings(){try{return JSON.parse(localStorage.getItem('arkan_bookings')||'{}');}catch{return {};}}
    function saveBookings(obj){localStorage.setItem('arkan_bookings',JSON.stringify(obj));}

    // Слоты с вероятностью занятости — до 19:00 занято ~70%, после — свободно чаще
    function buildSlotsForDate(date){
      const slots=[];const rng=Math.random;
      for(let h=10;h<22;h++){
        for(let m of ["00","30"]){
          const label=`${String(h).padStart(2,'0')}:${m}`;
          let busy=false;
          if(h<19){busy=rng()<0.7;} // до 19:00 около 70% занято
          else if(h<21){busy=rng()<0.4;} // вечером около 40%
          else {busy=rng()<0.2;} // к концу дня почти свободно
          slots.push({time:label,busy});
        }
      }
      return slots;
    }

    async function notifyBooking(payload){
      if(!NOTIFY_ENABLED||!RELAY_URL)return;
      try{
        const res = await fetch(RELAY_URL,{
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body:JSON.stringify(payload)
        });
        console.log('Response:', await res.text());
      }catch(e){
        console.warn('Ошибка отправки уведомления',e);
      }
    }

    function ArkhanDnyaApp(){
      const [selectedDate,setSelectedDate]=React.useState(startOfDay(new Date()));
      const [name,setName]=React.useState('');
      const [pendingSlot,setPendingSlot]=React.useState(null);
      const [showModal,setShowModal]=React.useState(false);
      const [reloadFlag,setReloadFlag]=React.useState(0);

      const days=React.useMemo(()=>{const arr=[];for(let i=0;i<15;i++)arr.push(addDays(startOfDay(new Date()),i));return arr;},[]);
      const slots=React.useMemo(()=>buildSlotsForDate(selectedDate),[selectedDate,reloadFlag]);
      const bookings=React.useMemo(()=>loadBookings(),[reloadFlag]);
      const slotsWithBookings=React.useMemo(()=>{
        const key=fmtDateKey(selectedDate);
        const bookedForDay=bookings[key]||{};
        return slots.map(s=>{
          const b=bookedForDay[s.time]||null;
          if(b)return {...s,booked:true,bookedBy:b.name};
          return {...s,booked:s.busy,bookedBy:s.busy?'—':''};
        });
      },[slots,bookings,selectedDate]);

      function openBooking(slot){if(slot.booked)return;setPendingSlot(slot);setShowModal(true);}
      function confirmBooking(){
        if(!name.trim()||!pendingSlot)return;
        const key=fmtDateKey(selectedDate);
        const all=loadBookings();
        all[key]=all[key]||{};
        if(all[key][pendingSlot.time]){
          alert('Слот занят');setShowModal(false);setName('');return;
        }
        const record={name:name.trim(),createdAt:new Date().toISOString()};
        all[key][pendingSlot.time]=record;saveBookings(all);
        notifyBooking({site:'Аркан Дня',date:key,time:pendingSlot.time,name:record.name,createdAt:record.createdAt,tz:Intl.DateTimeFormat().resolvedOptions().timeZone,userAgent:navigator.userAgent});
        setShowModal(false);setName('');setPendingSlot(null);setReloadFlag(x=>x+1);
        alert(`Запись подтверждена: ${fmtHumanDate(selectedDate)} в ${pendingSlot.time}`);
      }

      return (<div className="p-6 max-w-xl mx-auto text-center">
        <h1 className="text-2xl font-bold mb-4">Аркан Дня</h1>
        <p className="text-stone-400 mb-4">Выберите дату и время для записи. До вечера часть слотов уже занята.</p>
        <div className="flex flex-wrap gap-2 justify-center mb-6">
          {days.map(d=>(<button key={d.toISOString()} onClick={()=>setSelectedDate(d)} className={`px-3 py-1 rounded ${d.toDateString()===selectedDate.toDateString()?'bg-emerald-700':'bg-stone-800'}`}>{fmtHumanDate(d)}</button>))}
        </div>
        <div className="grid grid-cols-2 gap-2">
          {slotsWithBookings.map(slot=>(<button key={slot.time} onClick={()=>openBooking(slot)} disabled={slot.booked} className={`p-2 rounded ${slot.booked?'bg-stone-700':'bg-emerald-700 hover:bg-emerald-600'}`}>{slot.time}{slot.booked?' — Занято':''}</button>))}
        </div>
        {showModal&&(<div className="fixed inset-0 bg-black/80 flex items-center justify-center"><div className="bg-stone-900 p-6 rounded-xl max-w-sm w-full"><h2 className="text-lg font-semibold mb-2">Запись на {pendingSlot ? pendingSlot.time : ''}</h2><input value={name} onChange={e=>setName(e.target.value)} placeholder="Ваше имя" className="w-full p-2 rounded bg-stone-800 mb-4"/><div className="flex justify-end gap-2"><button onClick={()=>setShowModal(false)} className="px-4 py-2 bg-stone-700 rounded">Отмена</button><button onClick={confirmBooking} className="px-4 py-2 bg-emerald-600 rounded">Записаться</button></div></div></div>)}
      </div>);
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<ArkhanDnyaApp/>);
  </script>
</body>
</html>
